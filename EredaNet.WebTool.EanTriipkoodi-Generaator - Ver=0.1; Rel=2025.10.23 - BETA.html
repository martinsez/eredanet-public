<!DOCTYPE html>
<html lang="et-EE">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EAN-i ja Triipkoodi Generaator</title>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(180deg, #abc8ff 0%, #f4f7fb 100%);
}
body {
  display: flex;               /* enables flexbox layout */
  justify-content: center;     /* horizontal center */
  /* align-items: center;         /* vertical center */
  align-items: flex-start;
  padding-top: 5vh;
  padding-bottom: 5vh;
}
.container {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  max-width: 480px;
  width: 100%;
  background: #fdfdfd;
  padding: 20px 24px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  animation: fadeIn 0.5s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Header */
h1 {
  color: #222;
  margin-bottom: 20px;
  animation: fadeIn 0.8s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Form box */
form {
  max-width: 420px;
  width: 100%;
  background: #fdfdfd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 20px 24px;
  border-radius: 12px;
  animation: fadeIn 0.8s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
form * {
  box-sizing: border-box; /* ensures padding/borders don't break width alignment */
}
/* Inputs and controls */
label {
  display: block;
  margin-top: 10px;
  font-weight: bold;
  text-align: left;
}
input, select, button {
  display: block;
  width: 100%;                /* full width */
  max-width: 100%;            /* prevent overflow */
  padding: 10px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-family: inherit;
  font-size: 1rem;
  line-height: 1.4;
  box-sizing: border-box;
}
select {
  appearance: auto;
  background-color: #fff;
}
button {
  background-color: #0066cc;
  color: #fff;
  font-weight: bold;
  border: none;
  margin-top: 20px;
  cursor: pointer;
  transition: background 0.3s;
}
button:hover {
  background-color: #004d99;
}
.result-container {
  max-width: 420px;
  width: 100%;
  background: #fdfdfd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 20px 24px;
  border-radius: 12px;
  margin-top: 25px;               /* spacing below form */
  animation: fadeIn 0.8s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
form * {
  box-sizing: border-box; /* ensures padding/borders don't break width alignment */
}
.output {
  font-size: 1.1em;
  margin-bottom: 15px;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
}
/* Error messages in red */
.output.error {
  color: #d93025;                /* Google-red style for errors */
  font-weight: bold;
}
/* Success or standard message */
.output.success {
  font-weight: bold;
}
svg {
  max-width: 420px;
  width: 100%;
}
.field-wrapper { 
  display: none; 
}
</style>

</head>

<body>
  <div class="container">
    <h1>EAN-i ja Triipkoodi Generaator</h1>
    <form id="EanForm">
      <label for="EanType">Vali tootekoodi tüüp</label>
      <select id="EanType" required>
        <option value="">-</option>
      </select>
      <div id="dynamicFields"></div>
      <button type="submit">Arvuta EAN-13 kood ja triipkood</button>
    </form>
    <div class="result-container">
      <div class="output" id="result"></div>
      <svg id="barcode"></svg>
    </div>
  </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<script>
function calculateEAN13Checksum(code12) {
  let sum = 0;
  for (let i = 0; i < 12; i++) {
    const num = parseInt(code12.charAt(i), 10);
    sum += (i % 2 === 0) ? num : num * 3;
  }
  return (10 - (sum % 10)) % 10;
}

// --- Configuration ---
const EanTypes = {
  "GTIN": {
    name: "[GTIN] Toote kood",
    fields: ["productCode"], 
    labels: {productCode: "Toote kood ehk GTIN (12 või 13 numbrit)"}, 
    placeholders: {productCode: "nt. 474001234567" }, 
    maxLength: {productCode: 13},
    validate: v => !/^\d{12,13}$/.test(v.productCode) 
      ? "[VIGA] Toote kood ehk GTIN peab olema 12 või 13 numbrit pikk." 
      : null,
    compute: v => v.productCode.length===12
      ? v.productCode+calculateEAN13Checksum(v.productCode) 
      : v.productCode
  },
  "PLU26": { 
    name: "[PLU26] Toote kaalukood + kogus",
    fields: ["scaleCode", "count"], 
    labels: {scaleCode: "Toote kaalukood ehk PLU (4-6 numbrit)", count: "Toote kogus (1-9999 tk)"}, 
    placeholders: {scaleCode: "nt. 15009", count: "nt. 85"}, 
    maxLength: {scaleCode: 6, count: 4},
    validate: v => 
      !/^\d{4,6}$/.test(v.scaleCode) 
        ? "[VIGA] Toote kaalukood ehk PLU peab olema 4-6 numbrit pikk." 
        : (isNaN(v.count)||v.count<1||v.count>9999
        ?"[VIGA] Toote kogus peab olema vahemikus 1-9999 tk"
        :null),
    compute: v=> { 
      const c=String(v.count).padStart(4,'0'); 
      const base="26"+v.scaleCode+c; 
      return base.padEnd(12,'0')+calculateEAN13Checksum(base.padEnd(12,'0')); }
  },
  "PLU27": { 
    name: "[PLU27] Toote kaalukood + kaal",
    fields:["scaleCode", "weight"], 
    labels: {scaleCode: "Toote kaalukood ehk PLU (4-6 numbrit)", weight: "Toote kaal (1-9999 g)"}, 
    placeholders: {scaleCode: "nt. 15009", weight: "nt. 120"}, 
    maxLength: {scaleCode: 6, weight: 4},
    validate: v => 
      !/^\d{4,6}$/.test(v.scaleCode) 
        ? "[VIGA] Toote kaalukood ehk PLU peab olema 4-6 numbrit pikk." 
        : (isNaN(v.weight)||v.weight<1||v.weight>9999
        ?"[VIGA] Toote kaal peab olema vahemikus 1-9999 g."
        :null),
    compute: v=> { 
      const w=String(v.weight).padStart(4,'0'); 
      const base="27"+v.scaleCode+w; 
      return base.padEnd(12,'0')+calculateEAN13Checksum(base.padEnd(12,'0')); }
  },
  "PLU23": { 
    name: "[PLU23] Toote kaalukood + kaal",
    fields:["scaleCode", "weight"], 
    labels: {scaleCode: "Toote kaalukood ehk PLU (4-6 numbrit)", weight: "Toote kaal (1-9999 g)"}, 
    placeholders: {scaleCode: "nt. 15009", weight: "nt. 120"}, 
    maxLength: {scaleCode: 6, weight: 4},
    validate: v => 
      !/^\d{4,6}$/.test(v.scaleCode) 
        ? "[VIGA] Toote kaalukood ehk PLU peab olema 4-6 numbrit pikk." 
        : (isNaN(v.weight)||v.weight<1||v.weight>9999
        ?"[VIGA] Toote kaal peab olema vahemikus 1-9999 g."
        :null),
    compute: v=> { 
      const w=String(v.weight).padStart(4,'0'); 
      const base="23"+v.scaleCode+w; 
      return base.padEnd(12,'0')+calculateEAN13Checksum(base.padEnd(12,'0')); }
  }
};

// --- Generate type options ---
for (const key in EanTypes) {
  const opt = document.createElement('option');
  opt.value = key;
  opt.textContent = EanTypes[key].name; // ← use the descriptive name
  EanType.appendChild(opt);
}

// --- Generate dynamic input fields ---
const dynamicFields = document.getElementById('dynamicFields');
const allInputs = {};
const allWrappers = {};
const uniqueFields = [...new Set(Object.values(EanTypes).flatMap(t=>t.fields))];

uniqueFields.forEach(f => {
  const wrapper = document.createElement('div'); wrapper.className='field-wrapper'; wrapper.id=f+'Wrapper';
  const label = document.createElement('label'); label.id=f+'Label'; label.htmlFor=f;
  label.textContent = f; // temporary
  const input = document.createElement('input'); input.type='text'; input.id=f; input.placeholder='';
  wrapper.appendChild(label); wrapper.appendChild(input); dynamicFields.appendChild(wrapper);
  allInputs[f] = input;
  allWrappers[f] = wrapper;
});

// --- Reset ---
function resetInputs(){
  Object.values(allInputs).forEach(i=>i.value='');
  Object.values(allWrappers).forEach(w=>w.style.display='none');
  ResultDiv.innerHTML = '';
  BarcodeSvg.innerHTML = '';
}

// --- Show fields for selected type ---
function showFields(type){
  Object.values(allWrappers).forEach(w=>w.style.display='none');
  const t = EanTypes[type];
  t.fields.forEach(f=>{
    allWrappers[f].style.display='block';
    if(t.labels && t.labels[f]) allWrappers[f].querySelector('label').textContent=t.labels[f];
    if(t.placeholders && t.placeholders[f]) allInputs[f].placeholder = t.placeholders[f];
  });
}

// --- Dynamic input restrictions ---
Object.keys(allInputs).forEach(f=>{
  allInputs[f].addEventListener('input', ()=>{
    const type = EanType.value;
    if(!type) return;
    const max = EanTypes[type].maxLength[f] || 999;
    allInputs[f].value = allInputs[f].value.replace(/\D/g,'').slice(0,max);
  });
});

// --- Event listeners ---
EanType.addEventListener('change', ()=>{
  resetInputs();
  if(EanType.value) showFields(EanType.value);
});

const ResultDiv = document.getElementById('result');

function displayResult(message) {
  if (message.includes("[VIGA]")) {
    ResultDiv.classList.remove("success");
    ResultDiv.classList.add("error");
  } else {
    ResultDiv.classList.remove("error");
    ResultDiv.classList.add("success");
  }
  ResultDiv.innerHTML = message;
}

const BarcodeSvg = document.getElementById('barcode');

document.getElementById('EanForm').addEventListener('submit', e=>{
  e.preventDefault();
  BarcodeSvg.innerHTML = '';
  const type = EanType.value; if(!type) return;
  const vals = {}; Object.keys(allInputs).forEach(f=>vals[f]=allInputs[f].value.trim());
  const error = EanTypes[type].validate(vals);
  if(error){ 
    displayResult(error); 
    return; 
  }
  const ean13 = EanTypes[type].compute(vals);
  displayResult(`[EAN-13] ${ean13}`);
  JsBarcode("#barcode", ean13, {format:"ean13", displayValue:true, fontSize:18, width:2, height:100});
});
</script>

</html>